{% extends 'base.html' %}
{% block title %}讨论区 · 阅读空间{% endblock %}
{% block content %}
  <section class="card">
    <div class="section-header">
      <div>
        <h2>讨论总板块</h2>
        <p>所有书籍下的评论都会同步到这里，可快速跳转回对应书籍。</p>
      </div>
      <a class="btn secondary" href="{{ url_for('books') }}">去书架</a>
    </div>
  </section>

  <section class="card">
    <div class="section-header">
      <h3>{{ category_labels['discussion'] }}版</h3>
    </div>
    <ul class="discussion-list">
      {% for comment in discussion_comments %}
        <li class="discussion-item">
          <div class="avatar">{{ comment.username[0]|upper }}</div>
          <div>
            <p class="comment-text">{{ comment.username }}: {{ comment.content }}</p>
            <div class="comment-meta">
              <span>{{ comment.created_at|friendly_date }}</span>
              <a href="{{ url_for('book_detail', slug=comment.slug) }}">{{ comment.title }}</a>
              {% if session.get('user_id') == comment.user_id %}
                <form class="inline-form" method="post" action="{{ url_for('delete_comment_user', comment_id=comment.id) }}">
                  <input type="hidden" name="next" value="{{ request.path }}">
                  <button class="mini-btn danger" type="submit">删除评论</button>
                </form>
              {% endif %}
            </div>
            {% set replies = replies_map.get(comment.id, []) %}
            {% if replies %}
              <ul class="reply-list">
                {% for reply in replies %}
                  <li>
                    <div>
                      <strong>{{ reply.username }}</strong>：{{ reply.content }}
                      <span>{{ reply.created_at|friendly_date }}</span>
                    </div>
                    {% if session.get('user_id') == reply.user_id %}
                      <form class="inline-form" method="post" action="{{ url_for('delete_reply_user', reply_id=reply.id) }}">
                        <input type="hidden" name="next" value="{{ request.path }}">
                        <button class="mini-btn danger" type="submit">删除</button>
                      </form>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
            {% if session.get('user_id') %}
              <form class="reply-form" method="post" action="{{ url_for('reply_comment', comment_id=comment.id) }}">
                <textarea name="content" rows="2" placeholder="回复 {{ comment.username }}" required></textarea>
                <input type="hidden" name="next" value="{{ request.path }}">
                <button class="mini-btn" type="submit">回复</button>
              </form>
            {% endif %}
          </div>
        </li>
      {% else %}
        <li>暂时没有讨论，去任意书籍页面发表你的第一条评论吧。</li>
      {% endfor %}
    </ul>
  </section>

  <section class="card">
    <div class="section-header">
      <h3>{{ category_labels['reflection'] }}版</h3>
    </div>
    <ul class="discussion-list">
      {% for comment in reflection_comments %}
        <li class="discussion-item">
          <div class="avatar">{{ comment.username[0]|upper }}</div>
          <div>
            <p class="comment-text">{{ comment.username }}: {{ comment.content }}</p>
            <div class="comment-meta">
              <span>{{ comment.created_at|friendly_date }}</span>
              <a href="{{ url_for('book_detail', slug=comment.slug) }}">{{ comment.title }}</a>
              {% if session.get('user_id') == comment.user_id %}
                <form class="inline-form" method="post" action="{{ url_for('delete_comment_user', comment_id=comment.id) }}">
                  <input type="hidden" name="next" value="{{ request.path }}">
                  <button class="mini-btn danger" type="submit">删除评论</button>
                </form>
              {% endif %}
            </div>
            {% set replies = replies_map.get(comment.id, []) %}
            {% if replies %}
              <ul class="reply-list">
                {% for reply in replies %}
                  <li>
                    <div>
                      <strong>{{ reply.username }}</strong>：{{ reply.content }}
                      <span>{{ reply.created_at|friendly_date }}</span>
                    </div>
                    {% if session.get('user_id') == reply.user_id %}
                      <form class="inline-form" method="post" action="{{ url_for('delete_reply_user', reply_id=reply.id) }}">
                        <input type="hidden" name="next" value="{{ request.path }}">
                        <button class="mini-btn danger" type="submit">删除</button>
                      </form>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
            {% if session.get('user_id') %}
              <form class="reply-form" method="post" action="{{ url_for('reply_comment', comment_id=comment.id) }}">
                <textarea name="content" rows="2" placeholder="回复 {{ comment.username }}" required></textarea>
                <input type="hidden" name="next" value="{{ request.path }}">
                <button class="mini-btn" type="submit">回复</button>
              </form>
            {% endif %}
          </div>
        </li>
      {% else %}
        <li>还没有读后感，去任意书籍页面分享你的感受吧。</li>
      {% endfor %}
    </ul>
  </section>
{% endblock %}
