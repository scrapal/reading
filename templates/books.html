{% extends 'base.html' %}
{% block title %}书架 · 阅读空间{% endblock %}
{% block content %}
  <section class="card">
    <div class="section-header">
      <div>
        <h2>书架</h2>
        <p>查看不同年级的推荐书单，进入书页即可带着同学们一起讨论。</p>
      </div>
      <a class="btn secondary" href="{{ url_for('discussions') }}">去讨论区</a>
    </div>
  </section>

  {% if session.get('user_id') %}
  <section class="card admin-form-card">
    <div class="section-header">
      <h3>申请添加书籍</h3>
      <p>填写书籍信息并上传封面，管理员审核后将添加到书架。</p>
    </div>
    <form class="admin-form" method="post" action="{{ url_for('submit_book_request') }}" enctype="multipart/form-data">
      <label>书名*
        <input name="title" required placeholder="书籍名称">
      </label>
      <label>作者
        <input name="author" placeholder="作者">
      </label>
      <label>出版社
        <input name="publisher" placeholder="出版社">
      </label>
      <label>适用年级*
        <select name="grade" required>
          <option value="">请选择年级</option>
          <option value="六年级">六年级</option>
          <option value="七年级">七年级</option>
          <option value="八年级">八年级</option>
        </select>
      </label>
      <label>封面图片*
        <input type="file" name="cover_file" accept="image/*" required>
      </label>
      <button class="btn" type="submit">提交申请</button>
    </form>
  </section>

  {% if my_requests %}
  <section class="card">
    <div class="section-header">
      <h3>我的申请记录</h3>
    </div>
    <ul class="discussion-list">
      {% for req in my_requests %}
        <li class="discussion-item">
          <div class="admin-comment">
            <p class="comment-text">
              <strong>{{ req.title }}</strong> · {{ req.author or '未知作者' }} · {{ req.grade or '未分级' }}
            </p>
            <div class="comment-meta">
              <span>{{ req.created_at|friendly_date }}</span>
              {% if req.status == 'pending' %}
                <span class="category-pill" style="background: #ffa500;">待审核</span>
              {% elif req.status == 'approved' %}
                <span class="category-pill" style="background: #4caf50;">已通过</span>
              {% elif req.status == 'rejected' %}
                <span class="category-pill" style="background: #f44336;">已拒绝</span>
              {% endif %}
            </div>
          </div>
        </li>
      {% endfor %}
    </ul>
  </section>
  {% endif %}
  {% endif %}

  {% if grouped_books %}
    {% for grade in grade_order %}
      {% set grade_books = grouped_books.get(grade) %}
      {% if grade_books %}
        <section class="card">
          <div class="section-header">
            <div>
              <p class="eyebrow">{{ grade }}</p>
              <h2>{{ grade }}精选书目</h2>
            </div>
          </div>
          <div class="book-grid large">
            {% for book in grade_books %}
              <article class="book-card">
                <img src="{{ book.cover_url or 'https://placehold.co/320x180?text=Book' }}" alt="{{ book.title }}">
                <div class="book-card-info">
                  <span class="grade-badge">{{ book.grade }}</span>
                  <h4>{{ book.title }}</h4>
                <p class="book-meta">{{ book.author or '作者待定' }} · {{ book.publisher or '出版社待定' }}</p>
              </div>
                <a class="btn tertiary" href="{{ url_for('book_detail', slug=book.slug) }}">进入书页</a>
              </article>
            {% endfor %}
          </div>
        </section>
      {% endif %}
    {% endfor %}
  {% else %}
    <section class="card">
      <p>暂未收录书籍，稍后再来。</p>
    </section>
  {% endif %}
{% endblock %}
