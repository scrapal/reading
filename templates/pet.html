{% extends 'base.html' %}
{% block title %}宠物小屋 · 阅读空间{% endblock %}
{% block content %}
  <section class="card pet-card">
    <div class="section-header">
      <div>
        <h2>{{ pet.name }}</h2>
        <p>使用金币来喂养/照顾宠物，保持饱腹与快乐。</p>
      </div>
      <div class="coin-balance">当前金币：<strong>{{ coins }}</strong></div>
    </div>
    <div class="pet-stats">
      <div class="stat">
        <span>饱食度（越高越好）</span>
        <strong>{{ satiety }}/100</strong>
      </div>
      <div class="stat">
        <span>快乐值</span>
        <strong>{{ pet.happiness }}/100</strong>
      </div>
      <div class="stat">
        <span>最近照顾时间</span>
        <strong>{{ pet.last_care_at|friendly_date }}</strong>
      </div>
    </div>
    <div class="pet-playground">
      <div class="pet-field">
        <div class="pet-path"></div>
        <div class="pet-character" style="border-color: {{ pet_appearance.color }};">
          <div class="pet-svg-display" style="color: {{ pet_appearance.color }};">{{ pet_appearance.svg|safe }}</div>
        </div>
        <div class="pet-sparkle sparkle-1"></div>
        <div class="pet-sparkle sparkle-2"></div>
        {% for toy in owned_toys %}
          <div class="pet-toy" style="left: {{ toy.pos_x }}%; top: {{ toy.pos_y }}%;">
            <span class="toy-icon">{{ toy.icon }}</span>
          </div>
        {% endfor %}
      </div>
      <p class="note">{{ pet.name }}在草坪上散步，保持好心情吧！</p>
    </div>
  </section>

  <section class="card">
    <div class="section-header">
      <h3>玩具商店</h3>
    </div>
    <div class="toy-shop">
      {% for toy in toy_catalog %}
        <form class="toy-card" method="post" action="{{ url_for('pet_buy_toy', slug=toy.slug) }}">
          <div class="toy-icon large">{{ toy.icon }}</div>
          <div>
            <h4>{{ toy.name }}</h4>
            <p>{{ toy.description }}</p>
            <small>已拥有：{{ toy.owned }}</small>
          </div>
          <button class="btn" type="submit" {% if coins < toy.price %}disabled{% endif %}>
            {{ toy.price }} 金币
          </button>
        </form>
      {% else %}
        <p>暂无玩具可购买。</p>
      {% endfor %}
    </div>
  </section>

  <section class="card">
    <div class="section-header">
      <h3>互动项目</h3>
    </div>
    <form class="pet-actions" method="post">
      {% for key, action in actions.items() %}
        <button class="action-tile" name="action" value="{{ key }}" type="submit">
          <div>
            <h4>{{ action.label }}</h4>
            <p>{{ action.description }}</p>
          </div>
          <div class="action-meta">
            <span class="badge">耗费 {{ action.cost }} 金币</span>
            <small>饱食度 {{ '%+d' % (-action.hunger_delta) }}, 快乐 {{ '%+d' % action.happiness_delta }}</small>
          </div>
        </button>
      {% endfor %}
    </form>
    <p class="note">温馨提示：金币不足时无法进行互动，请先完成每日任务。</p>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const field = document.querySelector('.pet-field');
      const pet = document.querySelector('.pet-character');
      if (!field || !pet) return;

      const movePet = () => {
        const fieldRect = field.getBoundingClientRect();
        const petRect = pet.getBoundingClientRect();
        const sidePadding = 25;
        const groundOffset = 40;
        const xRange = Math.max(fieldRect.width - petRect.width - sidePadding * 2, 10);
        const yBaseline = fieldRect.height - petRect.height - groundOffset;
        const x = Math.random() * xRange + sidePadding;
        const y = yBaseline + (Math.random() * 10 - 5); // 轻微上下浮动
        pet.style.transform = `translate(${x}px, ${y}px)`;
      };

      movePet();
      setInterval(movePet, 5500);
    });
  </script>
{% endblock %}
