{% extends 'base.html' %}
{% block title %}{{ book.title }} · 阅读空间{% endblock %}
{% block content %}
  <section class="card book-detail">
    <img src="{{ book.cover_url or 'https://placehold.co/320x180?text=Book' }}" alt="{{ book.title }}">
    <div>
      <p class="eyebrow">{{ book.grade or '阅读计划' }} 阅读计划</p>
      <h2>{{ book.title }}</h2>
      <ul class="book-facts">
        <li><strong>作者</strong>{{ book.author or '待补充' }}</li>
        <li><strong>出版社</strong>{{ book.publisher or '待补充' }}</li>
      </ul>
      <p>这里主要展示封面、书名与评论，不收录正文内容。所有留言会同步到全站讨论区。</p>
      <a class="btn secondary" href="{{ url_for('discussions') }}">查看讨论总板块</a>
    </div>
  </section>

  <section class="card">
    <div class="section-header">
      <h3>发布评论</h3>
    </div>
    {% if session.get('user_id') %}
      <form class="comment-form" method="post">
        <label for="content">你的想法</label>
        <textarea id="content" name="content" rows="4" required placeholder="这本书也太感人了……"></textarea>
        <div class="category-toggle">
          <span>请选择类型：</span>
          <label><input type="radio" name="category" value="discussion" checked> {{ category_labels['discussion'] }}</label>
          <label><input type="radio" name="category" value="reflection"> {{ category_labels['reflection'] }}</label>
        </div>
        <button class="btn" type="submit">发布并同步讨论板</button>
      </form>
    {% else %}
      <p>请先 <a href="{{ url_for('login') }}">登录</a> 或 <a href="{{ url_for('register') }}">注册</a> 后再发表评论。</p>
    {% endif %}
  </section>

  <section class="card">
    <div class="section-header">
      <h3>{{ category_labels['discussion'] }}板块</h3>
    </div>
    <ul class="discussion-list">
      {% for comment in discussion_comments %}
        <li class="discussion-item">
          <div class="avatar">{{ comment.username[0]|upper }}</div>
          <div>
            <p class="comment-text">{{ comment.username }}: {{ comment.content }}</p>
            <div class="comment-meta">
              <span>{{ comment.created_at|friendly_date }}</span>
              <span>同步至讨论总板块</span>
            </div>
          </div>
        </li>
      {% else %}
        <li>还没有同学发起讨论，快来开启话题！</li>
      {% endfor %}
    </ul>
  </section>

  <section class="card">
    <div class="section-header">
      <h3>{{ category_labels['reflection'] }}板块</h3>
    </div>
    <ul class="discussion-list">
      {% for comment in reflection_comments %}
        <li class="discussion-item">
          <div class="avatar">{{ comment.username[0]|upper }}</div>
          <div>
            <p class="comment-text">{{ comment.username }}: {{ comment.content }}</p>
            <div class="comment-meta">
              <span>{{ comment.created_at|friendly_date }}</span>
              <span>同步至讨论总板块</span>
            </div>
          </div>
        </li>
      {% else %}
        <li>还没有读后感，写下你的体会吧！</li>
      {% endfor %}
    </ul>
  </section>
{% endblock %}
