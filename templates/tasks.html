{% extends 'base.html' %}
{% block title %}任务中心 · 阅读空间{% endblock %}
{% block content %}
  {% if user and current_user %}
  <section class="card streak-card">
    <div style="text-align: center;">
      <div class="streak-display">
        <svg class="streak-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <path d="M50 10 Q60 20 65 35 Q70 50 65 65 Q60 75 50 85 Q40 75 35 65 Q30 50 35 35 Q40 20 50 10" fill="#FF4444" opacity="0.9"/>
          <path d="M50 20 Q57 28 60 40 Q63 52 60 63 Q57 70 50 78 Q43 70 40 63 Q37 52 40 40 Q43 28 50 20" fill="#FF8800" opacity="0.95"/>
          <path d="M50 30 Q54 35 56 45 Q58 55 56 62 Q54 68 50 72 Q46 68 44 62 Q42 55 44 45 Q46 35 50 30" fill="#FFD700"/>
          <ellipse cx="50" cy="45" rx="8" ry="12" fill="#FFFFFF" opacity="0.6"/>
        </svg>
        <div class="streak-info">
          <div class="streak-number">{{ current_user.streak_count or 0 }}</div>
          <div class="streak-label">连续打卡天数</div>
        </div>
      </div>
      <p class="streak-description">
        每天完成"读书打卡"任务火苗 +1，断签归零。
        {% if is_current_boarder %}住宿生兑换验证码可获得 +5 火苗，工作日（周一至周五）不会因未打卡而断签。{% endif %}
      </p>
    </div>
  </section>
  {% endif %}

  <section class="card">
    <div class="section-header">
      <div>
        <h2>每日任务</h2>
        <p>完成下列任务可获得金币，用于在宠物页面购买互动项目。</p>
      </div>
      <a class="btn secondary" href="{{ url_for('pet') }}">我的宠物</a>
    </div>
    <p class="note">提示：在任意书籍页面选择“讨论”发表即可完成讨论任务；选择“读后感”并写满 50 字即可完成读后感任务，不能在此直接领取。</p>
    {% if not user %}
      <p>请先 <a href="{{ url_for('login') }}">登录</a> 后再完成任务。</p>
    {% endif %}
    <ul class="task-list">
      {% for row in task_rows %}
        <li class="task-item {% if row.completed %}done{% endif %}">
          <div>
            <h3>{{ row.task.name }}</h3>
            <p>{{ row.task.description }}</p>
          </div>
          <div class="task-meta">
            <span class="badge">+{{ row.task.coins_reward }} 金币</span>
            {% if row.completed %}
              <span class="status">今日已完成</span>
            {% elif row.task.code in ['write_reflection', 'share_comment'] %}
              <span class="status pending">前往书页完成对应操作</span>
            {% elif user %}
              <form method="post" action="{{ url_for('complete_task', task_id=row.task.id) }}">
                <button class="btn" type="submit">立即完成</button>
              </form>
            {% else %}
              <span class="status pending">登录后可完成</span>
            {% endif %}
          </div>
        </li>
      {% endfor %}
    </ul>
  </section>
{% endblock %}
