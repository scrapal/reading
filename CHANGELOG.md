# 阅读空间 - 更新日志

## v1.0.0 - 基础功能 (初始版本)

### 📖 核心功能上线

**用户系统**
- ✅ 用户注册（首个注册用户自动成为管理员）
- ✅ 用户登录（密码哈希加密）
- ✅ 用户退出

**书架系统**
- ✅ 书籍浏览（按年级分类：六年级、七年级、八年级）
- ✅ 预置书籍数据（24本精选书目）
- ✅ 书籍详情页
- ✅ 评论系统（讨论类、读后感类）
- ✅ 评论回复功能（支持嵌套回复）
- ✅ 讨论区（查看所有评论）

**技术栈**
- 后端：Python + Flask
- 数据库：SQLite (reading.db)
- 模板引擎：Jinja2
- 样式：自定义 CSS

**数据库表**
- `users`: 用户表
- `books`: 书籍表
- `comments`: 评论表
- `comment_replies`: 评论回复表

---

## v1.1.0 - 宠物系统

### 🐾 虚拟宠物功能

**宠物养成**
- ✅ 每个用户拥有独立虚拟宠物
- ✅ 宠物属性：饥饿值、快乐值、昵称
- ✅ 宠物互动：喂食、玩耍、送礼物
- ✅ 互动消耗金币，提升宠物状态
- ✅ 自定义宠物昵称

**宠物玩具系统**
- ✅ 玩具商店（弹力球、彩虹风车、音乐盒、迷你书堆）
- ✅ 使用金币购买玩具
- ✅ 玩具放置到草坪（随机位置）
- ✅ 查看所有用户的玩具（公共草坪）

**宠物互动成本**
- 喂食：10 金币（-25 饥饿，+6 快乐）
- 玩耍：8 金币（+5 饥饿，+12 快乐）
- 送礼物：15 金币（+0 饥饿，+18 快乐）

**新增数据库表**
- `pets`: 宠物表
- `toys`: 玩具表
- `user_toys`: 用户拥有的玩具表

---

## v1.2.0 - 任务系统

### ✅ 每日任务与金币系统

**金币经济**
- ✅ 用户注册时初始金币：0
- ✅ 完成任务获得金币奖励
- ✅ 消耗金币照顾宠物、购买玩具

**每日任务**
1. **读书打卡**（10 金币）
   - 手动完成任务

2. **写读后感**（15 金币）
   - 发表不少于 50 字的读后感
   - 自动检测并完成任务

3. **发布书评/评论**（8 金币）
   - 在书籍页面发表讨论
   - 自动检测并完成任务

**任务机制**
- ✅ 每日任务每天只能完成一次
- ✅ 任务状态跟踪（当天是否已完成）
- ✅ 任务页面显示所有任务和完成状态

**新增数据库表**
- `tasks`: 任务表
- `task_completions`: 任务完成记录表

**用户表更新**
- 新增字段：`coins` (金币余额)

---

## v1.3.0 - 管理员后台

### 👨‍💼 后台管理系统

**书籍管理**
- ✅ 添加新书籍（书名、作者、出版社、年级、封面 URL、自定义 Slug）
- ✅ 更新书籍信息（使用 Slug 冲突自动更新）
- ✅ 删除书籍
- ✅ 查看最新添加的书籍

**评论管理**
- ✅ 查看所有评论（讨论类、读后感类分别显示）
- ✅ 查看评论的所有回复
- ✅ 删除用户评论
- ✅ 删除评论回复
- ✅ 显示评论者用户名、时间、所属书籍

**用户管理**
- ✅ 查看所有用户列表
- ✅ 授予/移除管理员权限（至少保留一名管理员）
- ✅ 调整用户金币数量
- ✅ 删除用户账户（不能删除自己）
- ✅ 查看用户注册时间

**玩具管理**
- ✅ 查看所有用户放置的玩具
- ✅ 删除指定用户的玩具
- ✅ 显示玩具所属用户、放置时间

**权限控制**
- ✅ 仅管理员可访问后台
- ✅ 非管理员访问返回 403 错误
- ✅ 首个注册用户自动成为管理员

---

## v1.4.0 - 个人设置页面

### ⚙️ 用户个性化设置

**设置功能**
- ✅ 修改宠物昵称（1-20 字符）
- ✅ 设置头像 URL
- ✅ 修改用户名（3-20 字符，每 7 天一次）
- ✅ 用户名唯一性检查
- ✅ 用户名修改冷却时间

**用户表更新**
- 新增字段：`avatar` (头像 URL)
- 新增字段：`last_username_change` (上次修改用户名时间)

---

## v1.5.0 - 评论删除功能

### 🗑️ 用户自主管理

**用户功能**
- ✅ 删除自己发表的评论
- ✅ 删除自己发表的回复
- ✅ 删除后重定向回原页面

**权限验证**
- ✅ 仅评论/回复作者可删除
- ✅ 非作者删除返回 403 错误

---

## v2.0.0 - 云数据库迁移 (2025-11-09)

### 🚀 重大更新：迁移到云数据库

**数据库迁移**
- ✅ 从 SQLite 迁移到 PostgreSQL (Neon)
- ✅ 添加 psycopg2-binary、python-dotenv 依赖
- ✅ 所有 SQL 语法转换（32个函数）
  - `?` → `%s` 占位符
  - `AUTOINCREMENT` → `SERIAL`
  - `INSERT OR IGNORE` → `INSERT ... ON CONFLICT DO NOTHING`
  - 使用 `RealDictCursor` 返回字典格式结果
- ✅ 环境变量配置 (.env, .env.example)
- ✅ 更新 README.md 包含 Neon 设置说明
- ✅ 连接重试机制（最多3次，超时30秒）

**连接信息**
- 数据库：Neon PostgreSQL (3GB 免费额度，24/7 在线)
- 连接池配置：keepalives 心跳检测

**文件变更**
- `requirements.txt`: 新增 PostgreSQL 依赖
- `app.py`: 完全重写数据库连接和查询逻辑
- `.gitignore`: 排除 .env 和虚拟环境
- `README.md`: 添加云数据库配置指南

---

## v2.1.0 - 生产环境部署 (2025-11-09)

### ☁️ 部署到 Render 云平台

**部署配置**
- ✅ 创建 render.yaml 配置文件
- ✅ 创建 runtime.txt 指定 Python 3.12.7
- ✅ 配置环境变量（DATABASE_URL, FLASK_SECRET_KEY）
- ✅ 使用 gunicorn 作为生产服务器

**部署信息**
- 平台：Render (Free Plan)
- 地区：Singapore
- URL: https://reading-space.onrender.com
- 自动部署：启用（main 分支自动部署）

**问题修复**
1. **Python 3.13 兼容性问题**
   - 问题：psycopg2-binary 不支持 Python 3.13
   - 解决：锁定 Python 版本到 3.12.7

2. **RealDictCursor KeyError**
   - 问题：`fetchone()[0]` 无法访问字典
   - 解决：改为 `fetchone()['column_name']`
   - 影响函数：register(), admin_toggle_user(), admin_delete_user()

3. **数据库上下文问题**
   - 问题：在连接关闭后访问查询结果
   - 解决：调整 pet() 和 admin_dashboard() 函数缩进

4. **friendly_date 过滤器类型错误**
   - 问题：PostgreSQL 返回 datetime 对象，SQLite 返回字符串
   - 解决：添加类型检测，同时支持两种格式

---

## v2.2.0 - 本地文件上传支持 (2025-11-09)

### 📤 文件上传功能

**新增功能**
- ✅ 管理员上传书籍封面（从本地选择图片）
- ✅ 用户上传个人头像（从本地选择图片）
- ✅ 文件类型验证（PNG, JPG, JPEG, GIF, WEBP）
- ✅ 文件大小限制（最大 5MB）
- ✅ 安全文件名处理（secure_filename）
- ✅ 唯一文件名生成（时间戳）
- ✅ 自动创建上传目录结构

**文件结构**
```
static/uploads/
├── .gitkeep
├── covers/          # 书籍封面
│   └── .gitkeep
└── avatars/         # 用户头像
    └── .gitkeep
```

**技术实现**
- `save_uploaded_file()` 辅助函数 (app.py:301-325)
- `allowed_file()` 文件验证 (app.py:297-298)
- 表单添加 `enctype="multipart/form-data"`
- 移除 URL 输入选项，仅保留文件上传

**界面优化**
- 封面上传：`templates/admin.html:39-41`
- 头像上传：`templates/settings.html:29-31`
- 每个字段独立的 label 标签

---

## v2.3.0 - 书籍申请系统 (2025-11-09)

### 📚 用户书籍申请功能

**新增功能**
- ✅ 用户可申请添加新书籍到书架
- ✅ 申请表单：书名*、作者、出版社、年级*、封面图片*
- ✅ 查看申请历史和状态
- ✅ 管理员审核系统（通过/拒绝）
- ✅ 审核通过后自动添加到书架
- ✅ 申请状态跟踪（待审核/已通过/已拒绝）

**数据库变更**
- 新增 `book_requests` 表 (app.py:603-621)
  - 字段：user_id, title, author, publisher, grade, cover_url, status, created_at, reviewed_at, reviewed_by

**用户界面**
- 书架页面新增"申请书籍"按钮（仅登录用户） (templates/books.html:11-13)
- 独立申请页面 (`/request-book`)
  - 申请表单 (templates/request_book.html:14-42)
  - 申请历史记录 (templates/request_book.html:45-67)
  - 状态标签（橙色待审核、绿色已通过、红色已拒绝）

**管理员界面**
- 后台新增"待审核书籍申请"部分 (templates/admin.html:64-101)
- 显示所有待审核申请
- 提供"通过"和"拒绝"按钮
- 通过后自动生成 slug 并添加到书籍表

**路由**
- `GET /request-book`: 显示申请页面 (app.py:1769-1789)
- `POST /request-book/submit`: 提交申请 (app.py:1792-1835)
- `POST /admin/book-requests/<id>/approve`: 批准申请 (app.py:1324-1375)
- `POST /admin/book-requests/<id>/reject`: 拒绝申请 (app.py:1378-1399)

---

## v2.4.0 - 宠物造型选择系统 (2025-11-09)

### 🎨 宠物个性化功能

**新增功能**
- ✅ 10 种不同宠物造型供选择
  - 小猫（橙色、蓝色）
  - 小狗（棕色、粉色）
  - 兔子（白色、紫色）
  - 小熊（棕色、绿色）
  - 企鹅宝宝（黑色）
  - 黄色小鸟
- ✅ 注册后自动跳转到宠物选择页面
- ✅ 用户可自定义宠物名字（1-20 字符）
- ✅ 宠物页面显示选择的造型（emoji 表情）
- ✅ 防止重复创建宠物

**宠物配置** (app.py:348-359)
- 每种造型包含：id、名称、emoji、颜色
- 默认造型：cat-orange（橙色小猫）

**数据库变更**
- `pets` 表新增字段：`appearance TEXT DEFAULT 'cat-orange'` (app.py:645)
- 存储用户选择的宠物造型 ID

**用户界面**
- 新增宠物选择页面 (`templates/choose_pet.html`)
  - 网格布局展示所有宠物选项
  - 单选按钮样式化为卡片
  - 动态颜色主题（根据宠物颜色）
  - 首个选项默认选中
  - 悬停和选中时的视觉反馈
  - 宠物名字输入框

**宠物显示更新** (templates/pet.html:29-30)
- 从旧的 CSS 绘制（眼睛、嘴巴、身体）改为 emoji 表情显示
- 动态背景颜色和边框颜色（根据选择的宠物）

**路由**
- `GET /choose-pet`: 显示宠物选择页面 (app.py:1857-1898)
- `POST /choose-pet`: 保存选择的宠物 (app.py:1875-1896)
  - 验证造型有效性
  - 验证宠物名字长度
  - 防止已有宠物的用户重复创建

**注册流程优化** (app.py:1934-1940)
- 注册成功后自动登录
- 直接跳转到宠物选择页面（而非登录页）
- flash 消息提示："注册成功！请选择你的宠物伙伴~"

**技术细节**
- emoji 字符作为宠物图标（无需图片资源）
- 内联 CSS 样式（自包含设计）
- 使用 `next()` 函数查找匹配的宠物造型
- 默认回退到第一个造型（cat-orange）

---

## v2.4.1 - SVG 图标系统 (2025-11-09)

### 🖼️ 使用 SVG 替代 Emoji

**视觉升级**
- ✅ 将所有 emoji 表情替换为自定义 SVG 图标
- ✅ 每种宠物拥有独特的矢量图形设计
- ✅ 支持动态颜色主题（使用 currentColor）
- ✅ 添加阴影效果提升视觉层次

**SVG 设计特点**
- **猫**：圆形脸 + 三角形耳朵 + 微笑表情
- **狗**：圆形脸 + 垂耳 + 鼻子和嘴巴
- **兔子**：椭圆形脸 + 长耳朵 + 粉/白色鼻子
- **熊**：圆形脸 + 圆耳 + 鼻口部
- **企鹅**：椭圆身体 + 白色腹部 + 橙色嘴巴 + 翅膀
- **鸟**：圆形身体 + 翅膀 + 橙色尖嘴 + 爪子

**技术实现**
- 更新 `PET_APPEARANCES` 配置 (app.py:348-409)
  - 将 `emoji` 字段替换为 `svg` 字段
  - 每个 SVG 使用 `viewBox="0 0 100 100"` 标准化尺寸
  - 使用 `fill="currentColor"` 支持动态颜色

- 更新选择页面 (templates/choose_pet.html:20)
  - 使用 `{{ pet.svg|safe }}` 渲染 SVG
  - 通过 `style="color: {{ pet.color }}"` 应用颜色
  - 更新 CSS：`.pet-svg` 替代 `.pet-emoji`

- 更新宠物页面 (templates/pet.html:30)
  - 使用 `.pet-svg-display` 容器
  - 移除背景颜色，仅保留边框颜色

- 新增全局样式 (static/styles.css:655-667)
  - `.pet-svg-display` 容器样式
  - `drop-shadow` 滤镜效果

**优势**
- ✅ 跨平台一致性（不依赖系统 emoji 字体）
- ✅ 矢量图形，任意缩放不失真
- ✅ 自定义设计，风格统一
- ✅ 支持动态颜色（通过 CSS color 属性）
- ✅ 更小的文件体积（内联 SVG）

---

## v2.4.2 - 管理员宠物样式管理 (2025-11-09)

### 👨‍💼 管理员新增功能

**宠物样式管理**
- ✅ 管理员可修改任意用户的宠物样式
- ✅ 在用户管理表格中新增"宠物样式"列
- ✅ 下拉菜单显示所有可用宠物样式
- ✅ 自动选中用户当前的宠物样式
- ✅ 一键更新宠物样式

**功能细节**
- 如果用户尚未创建宠物，会自动创建并设置选择的样式
- 如果用户已有宠物，直接更新 appearance 字段
- 操作后显示成功/失败提示信息

**技术实现**
- 更新 `admin_dashboard()` 查询 (app.py:1128-1135)
  - 联表查询用户和宠物信息
  - 将 `pet_appearances` 传递给模板

- 新增路由 (app.py:1395-1442)
  - `POST /admin/users/<user_id>/pet-appearance`
  - 验证宠物样式有效性
  - 支持更新已有宠物或创建新宠物

- 更新管理员页面 (templates/admin.html:195, 211-223)
  - 在用户表格添加"宠物样式"列
  - 表单包含下拉菜单和"更新"按钮
  - 当前样式自动选中

**使用场景**
- 管理员帮助用户更换宠物样式
- 为新用户初始化宠物
- 批量调整用户宠物样式

---

## v2.4.3 - 移动端响应式优化 (2025-11-09)

### 📱 移动端适配

**书籍封面显示优化**
- ✅ 修复手机端书籍封面显示不全的问题
- ✅ 在移动端使用 `object-fit: contain` 完整显示封面
- ✅ 添加两层响应式断点适配不同屏幕尺寸

**响应式断点**

1. **中等屏幕** (`max-width: 720px`)
   - 书籍网格：最小列宽 150px
   - 封面高度：180px
   - 使用 `object-fit: contain` 完整显示
   - 网格间距：1rem
   - 卡片内边距：0.75rem

2. **小屏幕** (`max-width: 480px`)
   - 书籍网格：固定 2 列布局
   - 封面高度：160px
   - 网格间距：0.75rem
   - 卡片内边距：0.5rem
   - 标题字号：0.9rem
   - 元信息字号：0.75rem

**技术改进** (static/styles.css:269-275, 880-932)
- 桌面端封面：`object-fit: cover` + `object-position: center`
- 移动端封面：`object-fit: contain` 完整显示
- 添加浅灰色背景 `#f5f5f5` 填充空白区域
- 书籍详情页封面自适应：`max-width: 100%` + `height: auto`

**兼容性**
- ✅ iPhone (所有尺寸)
- ✅ Android 手机
- ✅ iPad 平板
- ✅ 桌面浏览器

**用户体验提升**
- 封面不再被裁剪，完整展示书籍封面设计
- 在小屏幕上保持良好的阅读体验
- 网格布局自适应，充分利用屏幕空间

---

## v2.4.4 - 全面移动端UI优化 (2025-11-09)

### 📱 移动端全局适配

**顶部导航栏优化** (static/styles.css:865-890)
- ✅ 垂直布局，左对齐
- ✅ 导航链接可换行，间距优化
- ✅ 认证按钮全宽显示，平分空间
- ✅ 按钮字号和内边距适配小屏幕

**Section Header 适配** (892-910)
- ✅ 垂直布局，按钮组全宽
- ✅ 按钮可换行，自适应宽度
- ✅ 最小宽度 120px，优化触控体验

**任务栏移动端优化** (912-930)
- ✅ 任务项垂直布局
- ✅ 任务元信息和按钮全宽
- ✅ 内边距和间距优化

**宠物功能适配** (932-965)
- ✅ 交互选项改为单列布局
- ✅ 玩具商店单列显示
- ✅ 宠物统计信息垂直堆叠
- ✅ 统计卡片全宽显示

**其他优化** (967-1008)
- ✅ 书籍详情页垂直布局
- ✅ 评论区标题适配
- ✅ 金币余额字号调整

**小屏幕专项优化** (`max-width: 480px`)
- ✅ 容器边距调整为 95%
- ✅ Logo 字号：1.25rem
- ✅ H2 标题：1.35rem
- ✅ H3 标题：1.15rem
- ✅ 卡片内边距：1rem
- ✅ 按钮字号：0.85rem
- ✅ 任务项、宠物选项内边距减小
- ✅ 统计信息字号调整
- ✅ 宠物草坪最小高度：200px

**触控优化**
- 按钮最小尺寸优化，便于点击
- 表单元素字号调整，改善输入体验
- 间距合理分配，避免误触

**性能优化**
- 字体大小层级清晰
- 内边距和间距统一缩放
- 保持视觉层次和可读性

---

## 开发时间线

```
v1.0.0 ─→ 注册/登录 + 书架系统
  │
v1.1.0 ─→ 宠物系统
  │
v1.2.0 ─→ 任务系统
  │
v1.3.0 ─→ 管理员后台
  │
v1.4.0 ─→ 个人设置
  │
v1.5.0 ─→ 评论删除
  │
v2.0.0 ─→ 云数据库迁移 (SQLite → PostgreSQL)
  │
v2.1.0 ─→ 部署到 Render
  │
v2.2.0 ─→ 文件上传功能
  │
v2.3.0 ─→ 书籍申请系统
  │
v2.4.0 ─→ 宠物造型选择系统
  │
v2.4.1 ─→ SVG 图标系统
  │
v2.4.2 ─→ 管理员宠物样式管理
  │
v2.4.3 ─→ 移动端响应式优化（书籍封面）
  │
v2.4.4 ─→ 全面移动端UI优化 (当前版本)
```

---

## 当前完整功能清单

### 用户功能
- ✅ 注册、登录、退出
- ✅ 浏览书籍（按年级分类）
- ✅ 查看书籍详情
- ✅ 发表评论（讨论/读后感）
- ✅ 回复评论
- ✅ 删除自己的评论和回复
- ✅ 完成每日任务赚取金币
- ✅ 照顾虚拟宠物（喂食、玩耍、送礼物）
- ✅ 选择宠物造型（10 种不同动物和颜色）
- ✅ 购买宠物玩具
- ✅ 修改用户名（7天一次）
- ✅ 上传头像
- ✅ 自定义宠物昵称
- ✅ 申请添加新书籍

### 管理员功能
- ✅ 添加/更新/删除书籍
- ✅ 上传书籍封面
- ✅ 删除用户评论和回复
- ✅ 授予/移除管理员权限
- ✅ 调整用户金币
- ✅ 修改用户宠物样式
- ✅ 删除用户账户
- ✅ 管理用户玩具
- ✅ 审核用户书籍申请
- ✅ 查看所有评论和回复

---

## 技术栈

**后端**
- Python 3.12.7
- Flask 2.2.5
- PostgreSQL (Neon)
- psycopg2-binary 2.9.9
- Gunicorn 21.2.0

**前端**
- Jinja2 模板引擎
- CSS 样式
- 响应式设计

**部署**
- Render 云平台（新加坡节点）
- 自动部署（Git push 自动触发）
- 环境变量管理

**文件上传**
- werkzeug.utils.secure_filename
- 支持格式：PNG, JPG, JPEG, GIF, WEBP
- 最大文件大小：5MB

---

## 数据统计

- **总代码量**：约 1,900 行 Python 代码
- **数据库表**：9 张表
- **路由数量**：30+ 个路由
- **模板文件**：15+ 个 HTML 模板
- **部署次数**：10+ 次成功部署
- **修复 Bug**：5 个主要问题

---

*最后更新：2025-11-09*
