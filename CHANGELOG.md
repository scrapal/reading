# 阅读空间 - 更新日志

## v1.0.0 - 基础功能 (初始版本)

### 📖 核心功能上线

**用户系统**
- ✅ 用户注册（首个注册用户自动成为管理员）
- ✅ 用户登录（密码哈希加密）
- ✅ 用户退出

**书架系统**
- ✅ 书籍浏览（按年级分类：六年级、七年级、八年级）
- ✅ 预置书籍数据（24本精选书目）
- ✅ 书籍详情页
- ✅ 评论系统（讨论类、读后感类）
- ✅ 评论回复功能（支持嵌套回复）
- ✅ 讨论区（查看所有评论）

**技术栈**
- 后端：Python + Flask
- 数据库：SQLite (reading.db)
- 模板引擎：Jinja2
- 样式：自定义 CSS

**数据库表**
- `users`: 用户表
- `books`: 书籍表
- `comments`: 评论表
- `comment_replies`: 评论回复表

---

## v1.1.0 - 宠物系统

### 🐾 虚拟宠物功能

**宠物养成**
- ✅ 每个用户拥有独立虚拟宠物
- ✅ 宠物属性：饥饿值、快乐值、昵称
- ✅ 宠物互动：喂食、玩耍、送礼物
- ✅ 互动消耗金币，提升宠物状态
- ✅ 自定义宠物昵称

**宠物玩具系统**
- ✅ 玩具商店（弹力球、彩虹风车、音乐盒、迷你书堆）
- ✅ 使用金币购买玩具
- ✅ 玩具放置到草坪（随机位置）
- ✅ 查看所有用户的玩具（公共草坪）

**宠物互动成本**
- 喂食：10 金币（-25 饥饿，+6 快乐）
- 玩耍：8 金币（+5 饥饿，+12 快乐）
- 送礼物：15 金币（+0 饥饿，+18 快乐）

**新增数据库表**
- `pets`: 宠物表
- `toys`: 玩具表
- `user_toys`: 用户拥有的玩具表

---

## v1.2.0 - 任务系统

### ✅ 每日任务与金币系统

**金币经济**
- ✅ 用户注册时初始金币：0
- ✅ 完成任务获得金币奖励
- ✅ 消耗金币照顾宠物、购买玩具

**每日任务**
1. **读书打卡**（10 金币）
   - 手动完成任务

2. **写读后感**（15 金币）
   - 发表不少于 50 字的读后感
   - 自动检测并完成任务

3. **发布书评/评论**（8 金币）
   - 在书籍页面发表讨论
   - 自动检测并完成任务

**任务机制**
- ✅ 每日任务每天只能完成一次
- ✅ 任务状态跟踪（当天是否已完成）
- ✅ 任务页面显示所有任务和完成状态

**新增数据库表**
- `tasks`: 任务表
- `task_completions`: 任务完成记录表

**用户表更新**
- 新增字段：`coins` (金币余额)

---

## v1.3.0 - 管理员后台

### 👨‍💼 后台管理系统

**书籍管理**
- ✅ 添加新书籍（书名、作者、出版社、年级、封面 URL、自定义 Slug）
- ✅ 更新书籍信息（使用 Slug 冲突自动更新）
- ✅ 删除书籍
- ✅ 查看最新添加的书籍

**评论管理**
- ✅ 查看所有评论（讨论类、读后感类分别显示）
- ✅ 查看评论的所有回复
- ✅ 删除用户评论
- ✅ 删除评论回复
- ✅ 显示评论者用户名、时间、所属书籍

**用户管理**
- ✅ 查看所有用户列表
- ✅ 授予/移除管理员权限（至少保留一名管理员）
- ✅ 调整用户金币数量
- ✅ 删除用户账户（不能删除自己）
- ✅ 查看用户注册时间

**玩具管理**
- ✅ 查看所有用户放置的玩具
- ✅ 删除指定用户的玩具
- ✅ 显示玩具所属用户、放置时间

**权限控制**
- ✅ 仅管理员可访问后台
- ✅ 非管理员访问返回 403 错误
- ✅ 首个注册用户自动成为管理员

---

## v1.4.0 - 个人设置页面

### ⚙️ 用户个性化设置

**设置功能**
- ✅ 修改宠物昵称（1-20 字符）
- ✅ 设置头像 URL
- ✅ 修改用户名（3-20 字符，每 7 天一次）
- ✅ 用户名唯一性检查
- ✅ 用户名修改冷却时间

**用户表更新**
- 新增字段：`avatar` (头像 URL)
- 新增字段：`last_username_change` (上次修改用户名时间)

---

## v1.5.0 - 评论删除功能

### 🗑️ 用户自主管理

**用户功能**
- ✅ 删除自己发表的评论
- ✅ 删除自己发表的回复
- ✅ 删除后重定向回原页面

**权限验证**
- ✅ 仅评论/回复作者可删除
- ✅ 非作者删除返回 403 错误

---

## v2.0.0 - 云数据库迁移 (2025-11-09)

### 🚀 重大更新：迁移到云数据库

**数据库迁移**
- ✅ 从 SQLite 迁移到 PostgreSQL (Neon)
- ✅ 添加 psycopg2-binary、python-dotenv 依赖
- ✅ 所有 SQL 语法转换（32个函数）
  - `?` → `%s` 占位符
  - `AUTOINCREMENT` → `SERIAL`
  - `INSERT OR IGNORE` → `INSERT ... ON CONFLICT DO NOTHING`
  - 使用 `RealDictCursor` 返回字典格式结果
- ✅ 环境变量配置 (.env, .env.example)
- ✅ 更新 README.md 包含 Neon 设置说明
- ✅ 连接重试机制（最多3次，超时30秒）

**连接信息**
- 数据库：Neon PostgreSQL (3GB 免费额度，24/7 在线)
- 连接池配置：keepalives 心跳检测

**文件变更**
- `requirements.txt`: 新增 PostgreSQL 依赖
- `app.py`: 完全重写数据库连接和查询逻辑
- `.gitignore`: 排除 .env 和虚拟环境
- `README.md`: 添加云数据库配置指南

---

## v2.1.0 - 生产环境部署 (2025-11-09)

### ☁️ 部署到 Render 云平台

**部署配置**
- ✅ 创建 render.yaml 配置文件
- ✅ 创建 runtime.txt 指定 Python 3.12.7
- ✅ 配置环境变量（DATABASE_URL, FLASK_SECRET_KEY）
- ✅ 使用 gunicorn 作为生产服务器

**部署信息**
- 平台：Render (Free Plan)
- 地区：Singapore
- URL: https://reading-space.onrender.com
- 自动部署：启用（main 分支自动部署）

**问题修复**
1. **Python 3.13 兼容性问题**
   - 问题：psycopg2-binary 不支持 Python 3.13
   - 解决：锁定 Python 版本到 3.12.7

2. **RealDictCursor KeyError**
   - 问题：`fetchone()[0]` 无法访问字典
   - 解决：改为 `fetchone()['column_name']`
   - 影响函数：register(), admin_toggle_user(), admin_delete_user()

3. **数据库上下文问题**
   - 问题：在连接关闭后访问查询结果
   - 解决：调整 pet() 和 admin_dashboard() 函数缩进

4. **friendly_date 过滤器类型错误**
   - 问题：PostgreSQL 返回 datetime 对象，SQLite 返回字符串
   - 解决：添加类型检测，同时支持两种格式

---

## v2.2.0 - 本地文件上传支持 (2025-11-09)

### 📤 文件上传功能

**新增功能**
- ✅ 管理员上传书籍封面（从本地选择图片）
- ✅ 用户上传个人头像（从本地选择图片）
- ✅ 文件类型验证（PNG, JPG, JPEG, GIF, WEBP）
- ✅ 文件大小限制（最大 5MB）
- ✅ 安全文件名处理（secure_filename）
- ✅ 唯一文件名生成（时间戳）
- ✅ 自动创建上传目录结构

**文件结构**
```
static/uploads/
├── .gitkeep
├── covers/          # 书籍封面
│   └── .gitkeep
└── avatars/         # 用户头像
    └── .gitkeep
```

**技术实现**
- `save_uploaded_file()` 辅助函数 (app.py:301-325)
- `allowed_file()` 文件验证 (app.py:297-298)
- 表单添加 `enctype="multipart/form-data"`
- 移除 URL 输入选项，仅保留文件上传

**界面优化**
- 封面上传：`templates/admin.html:39-41`
- 头像上传：`templates/settings.html:29-31`
- 每个字段独立的 label 标签

---

## v2.3.0 - 书籍申请系统 (2025-11-09)

### 📚 用户书籍申请功能

**新增功能**
- ✅ 用户可申请添加新书籍到书架
- ✅ 申请表单：书名*、作者、出版社、年级*、封面图片*
- ✅ 查看申请历史和状态
- ✅ 管理员审核系统（通过/拒绝）
- ✅ 审核通过后自动添加到书架
- ✅ 申请状态跟踪（待审核/已通过/已拒绝）

**数据库变更**
- 新增 `book_requests` 表 (app.py:603-621)
  - 字段：user_id, title, author, publisher, grade, cover_url, status, created_at, reviewed_at, reviewed_by

**用户界面**
- 书架页面新增"申请书籍"按钮（仅登录用户） (templates/books.html:11-13)
- 独立申请页面 (`/request-book`)
  - 申请表单 (templates/request_book.html:14-42)
  - 申请历史记录 (templates/request_book.html:45-67)
  - 状态标签（橙色待审核、绿色已通过、红色已拒绝）

**管理员界面**
- 后台新增"待审核书籍申请"部分 (templates/admin.html:64-101)
- 显示所有待审核申请
- 提供"通过"和"拒绝"按钮
- 通过后自动生成 slug 并添加到书籍表

**路由**
- `GET /request-book`: 显示申请页面 (app.py:1769-1789)
- `POST /request-book/submit`: 提交申请 (app.py:1792-1835)
- `POST /admin/book-requests/<id>/approve`: 批准申请 (app.py:1324-1375)
- `POST /admin/book-requests/<id>/reject`: 拒绝申请 (app.py:1378-1399)

---

## 开发时间线

```
v1.0.0 ─→ 注册/登录 + 书架系统
  │
v1.1.0 ─→ 宠物系统
  │
v1.2.0 ─→ 任务系统
  │
v1.3.0 ─→ 管理员后台
  │
v1.4.0 ─→ 个人设置
  │
v1.5.0 ─→ 评论删除
  │
v2.0.0 ─→ 云数据库迁移 (SQLite → PostgreSQL)
  │
v2.1.0 ─→ 部署到 Render
  │
v2.2.0 ─→ 文件上传功能
  │
v2.3.0 ─→ 书籍申请系统 (当前版本)
```

---

## 当前完整功能清单

### 用户功能
- ✅ 注册、登录、退出
- ✅ 浏览书籍（按年级分类）
- ✅ 查看书籍详情
- ✅ 发表评论（讨论/读后感）
- ✅ 回复评论
- ✅ 删除自己的评论和回复
- ✅ 完成每日任务赚取金币
- ✅ 照顾虚拟宠物（喂食、玩耍、送礼物）
- ✅ 购买宠物玩具
- ✅ 修改用户名（7天一次）
- ✅ 上传头像
- ✅ 自定义宠物昵称
- ✅ 申请添加新书籍

### 管理员功能
- ✅ 添加/更新/删除书籍
- ✅ 上传书籍封面
- ✅ 删除用户评论和回复
- ✅ 授予/移除管理员权限
- ✅ 调整用户金币
- ✅ 删除用户账户
- ✅ 管理用户玩具
- ✅ 审核用户书籍申请
- ✅ 查看所有评论和回复

---

## 技术栈

**后端**
- Python 3.12.7
- Flask 2.2.5
- PostgreSQL (Neon)
- psycopg2-binary 2.9.9
- Gunicorn 21.2.0

**前端**
- Jinja2 模板引擎
- CSS 样式
- 响应式设计

**部署**
- Render 云平台（新加坡节点）
- 自动部署（Git push 自动触发）
- 环境变量管理

**文件上传**
- werkzeug.utils.secure_filename
- 支持格式：PNG, JPG, JPEG, GIF, WEBP
- 最大文件大小：5MB

---

## 数据统计

- **总代码量**：约 1,900 行 Python 代码
- **数据库表**：9 张表
- **路由数量**：30+ 个路由
- **模板文件**：15+ 个 HTML 模板
- **部署次数**：10+ 次成功部署
- **修复 Bug**：5 个主要问题

---

*最后更新：2025-11-09*
